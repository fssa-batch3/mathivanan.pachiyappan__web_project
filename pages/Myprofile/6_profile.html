<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profile-Venom.com</title>
  <link rel="stylesheet" href="../../assets/css/3_home.css">
  <link rel="stylesheet" href="../../assets/css/6_profile.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="icon" href="../../assets/images/logo.png" type="image/x-icon">
</head>

<body>
  <!--Header-->

  <div class="header__wrapper">
    <header id="profile_bg"></header>
    <div class="cols__container">
      <div class="left__col">
        <div class="img__container">
          <p id="profile_image"></p>
          <span></span>
        </div>
        <h2 id="profile_name"></h2>
        <p id="user_job"></p>
        <p id="profile_email"></p>
        <p id="user_date"></p>
        <i class="fa fa-map-marker" aria-hidden="true" id="map_icon"></i>
        <p id="user_country"></p>

        <ul class="about">
          <li><a href="../follow/7_follow.html"><span id="followers">0</span>Followers</a></li>
          <li><a href="../follow/7_follow.html"><span id="following">0</span>Following</a></li>
          <li><a href="#"><span id="totall_post">0</span>Totall Post</a></li>
        </ul>

        <div class="content">
          <p id="user_tag" class="tag_line"></p>
          <p id="user_bio"></p>
        </div>
        <div id="editBtn">
          <!-- <button><a href="./11_edit_profile.html">Edit Profile</a></button> -->
        </div>
      </div>
      <div class="right__col">
        <nav>
          <ul>
            <li><a href="#">posts</a></li>
            <li><a href="./6_savedpost.html">saved items</a></li>
            <li><a href="./6_toptrend.html">Top Trending</a></li>
          </ul>
          <button type="submit" id="follow_btn">Follow</button>
        </nav>

        <div id="posts" class="post_list"></div>
      </div>
    </div>
  </div>
  <div class="icons">
    <a href="#"><i class="fa fa-facebook" style="color: #000;"></i></a>
    <a href="#"><i class="fa fa-instagram" style="color: #000;"></i></a>
    <a href="#"><i class="fa fa-twitter" style="color: #000;"></i></a>
    <a href="#"><i class="fa fa-github" style="color: #000;"></i></a>
    <p>Â© 2023 Venom.com All rights reserved</p>
  </div>
  </div>

  <script>

    // let imageURL2 = localStorage.getItem("imageURL2");
    // let imgBox2 = document.getElementById("profile_image");
    // imgBox2.style.backgroundImage = "url(" + imageURL2 + ")";

    const params = new URLSearchParams(window.location.search);
    const userId = params.get('user_ID');

    let email_ID = JSON.parse(localStorage.getItem("email_ID"));
    let user_records = JSON.parse(localStorage.getItem("user_records"));

    function login_data(e) {
      return e.user_email == userId;
    }

    user_data = user_records.find(login_data);


    let profile_banner = user_data['user_banner'];
    document.getElementById("profile_bg").style.backgroundImage = "url(" + profile_banner + ")";
    let profile_image = user_data['user_profile'];
    document.getElementById("profile_image").style.backgroundImage = "url(" + profile_image + ")";
    document.getElementById("profile_name").innerText = user_data['user_name'];
    document.getElementById("profile_email").innerText = user_data['user_email'];
    document.getElementById("user_date").innerText = user_data['user_date'];
    document.getElementById("user_country").innerText = user_data['user_country'];
    document.getElementById("user_job").innerText = user_data['user_job'];
    document.getElementById("user_tag").innerText = user_data['user_tag'];
    document.getElementById("user_bio").innerText = user_data['user_bio'];
    
    // let profile_banner 
    // let imgBox2 = 
    // imgBox2.style.backgroundImage = "url(" + profile_banner + ")";

    // filter user posts///////////////////
    let all_post = JSON.parse(localStorage.getItem("blog_records"));

    let user_post = all_post.filter(post => post.unique_id == userId);
    let post_count = document.getElementById("totall_post");
    post_count.innerText = user_post.length;

    for (let i = 0; i < user_post.length; i++) {

      // Create the post_box div element
      const postBoxDiv = document.createElement("div");
      postBoxDiv.classList.add("post_box");

      // Create the h2 element for the post content
      const postContentH2 = document.createElement("h2");
      postContentH2.classList.add("post_content");

      a_tag = document.createElement("a");
      a_tag.setAttribute("href", "../posts/8-1_post.html?post_ID=" + user_post[i]["post_id"]);
      a_tag.innerText = user_post[i]["title"];
      postContentH2.append(a_tag);

      // Create the p element for the time and date
      const timeDateP = document.createElement("p");
      timeDateP.setAttribute("class", "time_date");
      timeDateP.innerHTML = "Published On : " + user_post[i]["timestamp"];

      // Create the second p element for the post content
      const postContentP = document.createElement("p");
      postContentP.classList.add("post_content");
      postContentP.innerHTML = user_post[i]["content"];

      // Append the h2 and p elements to the post_box div
      postBoxDiv.appendChild(postContentH2);
      postBoxDiv.appendChild(timeDateP);
      postBoxDiv.appendChild(postContentP);

      // Append the post_box div to the div with id "posts"
      const postsDiv = document.getElementById("posts");
      postsDiv.appendChild(postBoxDiv);

      let edit_button = document.createElement("button");
      edit_button.setAttribute("class", "edit_btn");
      edit_button.setAttribute("data-id", user_post[i]["post_id"]);
      edit_button.innerText = "Edit";
      postBoxDiv.append(edit_button);

      // Delete button JSON and JS code
      // Declare and initialize delete_button before the event listener
      const delete_button = document.createElement("button");
      delete_button.setAttribute("class", "delete_btn");
      delete_button.innerText = "Delete";
      postBoxDiv.append(delete_button);

      // Add event listener to delete_button
      delete_button.addEventListener("click", function () {
        if (confirm("Are you sure to Delete ?")) {
          let post_ID = localStorage.getItem("post_id");
          let blog_records = JSON.parse(localStorage.getItem("blog_records"));

          // Find the index of the post to delete
          const indexOfUser = blog_records.find(e => e.post_id == post_ID);

          // Remove the post from the array
          if (indexOfUser !== -1) {
            blog_records.splice(indexOfUser, 1);
          }

          localStorage.setItem('blog_records', JSON.stringify(blog_records));
          location.reload();
        }
      });
      let edit = document.querySelectorAll("button.edit_btn");
      edit.forEach(function (find_post) {
        find_post.addEventListener("click", function () {
          const id = this.dataset.id

          localStorage.setItem("post_id", JSON.stringify(id));
          window.location.href = "../user_services/4_creat_post.html";
        })
      });

      if (userId === email_ID) {
        delete_button.style.display = 'block';
        edit_button.style.display = 'block';
      } else {
        delete_button.style.display = 'none';
        edit_button.style.display = 'none';
      }
    };
    // localStorage.getItem("key", value)


    // const userID = JSON.parse(localStorage.getItem('email_ID'));

    // get the follow data from local storage or initialize it as an empty array
    let follow_Data = JSON.parse(localStorage.getItem('follow_data')) || [];

    // check if the user is already following
    let isFollowing = follow_Data.filter(data => data.userId !== email_ID);

    // update the button state based on whether the user is following or not
    const followBtn = document.getElementById('follow_btn');
    // followBtn.textContent = isFollowing ? 'Follow' : 'Following';

    // add event listener to the follow button
    followBtn.addEventListener('click', () => {
      if (isFollowing) {

        // add the user id to the follow data array
        follow_Data.push({ email_ID, userId});

        // update the local storage
        localStorage.setItem('follow_data', JSON.stringify(follow_Data));

        // update the button state
        followBtn.innerText = 'Following';

        // set isFollowing to true
        isFollowing = false;

        // location.reload();

      } else {
        // remove the user id from the follow data array
        follow_Data = follow_Data.filter(data => data.userId === email_ID);

        // update the local storage
        localStorage.setItem('follow_data', JSON.stringify(follow_Data));

        // update the button state
        followBtn.innerText = 'Follow';

        // set isFollowing to false
        isFollowing = true;
      }
      // location.reload();

    });

    if (userId === email_ID) {
      followBtn.style.display = 'none';
    } else {
      followBtn.style.display = 'block';
    }


    let editBtn = document.getElementById("editBtn");

    button_tag = document.createElement("button");
    a_tag = document.createElement("a");
    a_tag.setAttribute("href", "./11_edit_profile.html?user_ID=" + user_data["user_email"]);
    a_tag.innerHTML = "Edit Profile";
    button_tag.appendChild(a_tag);

    editBtn.append(button_tag);

    if (userId === email_ID) {
      editBtn.style.display = 'block';
    } else {
      editBtn.style.display = 'none';
    }

    let followRc = JSON.parse(localStorage.getItem("follow_data"));

    let followData = followRc.filter(follow => follow.email_ID == email_ID);
    let follow_count = document.getElementById("followers");
    let following_count = document.getElementById("following");

    if(userId !== email_ID){
    follow_count.innerText = followData.length;
    }
    if(userId === email_ID){
    following_count.innerText = followData.length;
    }

  </script>
  <script src="/assets/header.js"></script>
</body>

</html>